# ============================================================================
# ServiceMonitors para monitorar aplicações Nexo no Grafana/Prometheus
# ============================================================================
# Prometheus já está configurado para coletar métricas de todos os namespaces
# via servicemonitorSelectorNilUsesHelmValues: false
#
# Este arquivo cria ServiceMonitors para os serviços Nexo exportarem métricas
# ============================================================================

---
# ServiceMonitor para nexo-be (Backend NestJS)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: nexo-be
  namespace: nexo-develop
  labels:
    app: nexo-be
    environment: develop
spec:
  selector:
    matchLabels:
      app: nexo-be
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: nexo-be
  namespace: nexo-prod
  labels:
    app: nexo-be
    environment: prod
spec:
  selector:
    matchLabels:
      app: nexo-be
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
# ServiceMonitor para nexo-fe (Frontend Next.js)
# Next.js não expõe métricas Prometheus por padrão
# Use: https://github.com/lirantal/next-prometheus-plugin
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: nexo-fe
  namespace: nexo-develop
  labels:
    app: nexo-fe
    environment: develop
spec:
  selector:
    matchLabels:
      app: nexo-fe
  endpoints:
    - port: http
      path: /api/metrics
      interval: 30s
      scrapeTimeout: 10s

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: nexo-fe
  namespace: nexo-prod
  labels:
    app: nexo-fe
    environment: prod
spec:
  selector:
    matchLabels:
      app: nexo-fe
  endpoints:
    - port: http
      path: /api/metrics
      interval: 30s
      scrapeTimeout: 10s

---
# ServiceMonitor para nexo-auth (Keycloak)
# Keycloak expõe métricas em /metrics por padrão (quando habilitado)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: nexo-auth
  namespace: nexo-develop
  labels:
    app: nexo-auth
    environment: develop
spec:
  selector:
    matchLabels:
      app: nexo-auth
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: nexo-auth
  namespace: nexo-prod
  labels:
    app: nexo-auth
    environment: prod
spec:
  selector:
    matchLabels:
      app: nexo-auth
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
