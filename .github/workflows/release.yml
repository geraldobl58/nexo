# ============================================================================
# Nexo Platform - Release to Production
# ============================================================================
# Pipeline de release que √© disparada por cria√ß√£o de tags sem√¢nticas (v*.*.*)
#
# Funcionalidades:
#   üè∑Ô∏è Cria GitHub Release com changelog autom√°tico
#   üê≥ Build multi-platform (amd64, arm64)
#   üì¶ Push para GitHub Container Registry (ghcr.io) com tag de vers√£o
#   üìù Atualiza Helm values de produ√ß√£o com a vers√£o da release
#   üîî Notifica via Discord
#
# Trigger: git tag v1.0.0 && git push --tags
# ============================================================================

name: Release

on:
  push:
    tags:
      - "v*.*.*"

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ${{ github.repository_owner }}

permissions:
  contents: write
  packages: write

jobs:
  # ==========================================================================
  # STAGE 1: Validate Tag & Extract Version
  # ==========================================================================
  validate:
    name: üè∑Ô∏è Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_major: ${{ steps.version.outputs.major }}
      version_minor: ${{ steps.version.outputs.minor }}
      version_patch: ${{ steps.version.outputs.patch }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"

          # Validar formato semver
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "‚ùå Tag inv√°lida: $TAG (esperado: v*.*.* ou v*.*.*-rc.*)"
            exit 1
          fi

          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3 | cut -d- -f1)

          # Verificar se √© pre-release
          if [[ "$VERSION" == *-* ]]; then
            PRERELEASE="true"
          else
            PRERELEASE="false"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT

          echo "üè∑Ô∏è Tag: $TAG"
          echo "üì¶ Version: $VERSION"
          echo "üî¢ Major: $MAJOR, Minor: $MINOR, Patch: $PATCH"
          echo "üîñ Pre-release: $PRERELEASE"

      - name: Verify tag is on main branch
        run: |
          # Verificar se o commit da tag est√° na branch main
          TAG_COMMIT=$(git rev-list -n 1 "${GITHUB_REF#refs/}")

          if git branch -r --contains "$TAG_COMMIT" | grep -q "origin/main"; then
            echo "‚úÖ Tag est√° na branch main"
          else
            echo "‚ö†Ô∏è AVISO: Tag n√£o est√° na branch main!"
            echo "   Para releases de produ√ß√£o, fa√ßa tag na main."
            echo "   Continuando mesmo assim..."
          fi

  # ==========================================================================
  # STAGE 2: Build & Push - All Services (produ√ß√£o)
  # ==========================================================================
  build-backend:
    name: üê≥ Build Backend v${{ needs.validate.outputs.version }}
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/nexo-be/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:v${{ needs.validate.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:${{ needs.validate.outputs.version_major }}.${{ needs.validate.outputs.version_minor }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:latest
          cache-to: type=inline

  build-frontend:
    name: üê≥ Build Frontend v${{ needs.validate.outputs.version }}
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/nexo-fe/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:v${{ needs.validate.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:${{ needs.validate.outputs.version_major }}.${{ needs.validate.outputs.version_minor }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:latest
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.g3developer.online
            NEXT_PUBLIC_KEYCLOAK_URL=https://auth.g3developer.online
            NEXT_PUBLIC_KEYCLOAK_REALM=nexo
            NEXT_PUBLIC_KEYCLOAK_CLIENT_ID=nexo-web
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:latest
          cache-to: type=inline

  build-auth:
    name: üê≥ Build Auth v${{ needs.validate.outputs.version }}
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/nexo-auth/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:v${{ needs.validate.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:${{ needs.validate.outputs.version_major }}.${{ needs.validate.outputs.version_minor }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:latest
          cache-to: type=inline

  # ==========================================================================
  # STAGE 3: Update Helm Values (produ√ß√£o)
  # ==========================================================================
  update-helm:
    name: üìù Update Helm Prod Values
    runs-on: ubuntu-latest
    needs:
      - validate
      - build-backend
      - build-frontend
      - build-auth
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update production Helm values
        run: |
          VERSION="v${{ needs.validate.outputs.version }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          REGISTRY="${{ env.REGISTRY }}"
          IMAGE_OWNER="${{ env.IMAGE_OWNER }}"

          echo "üîÑ Updating production values to version: $VERSION"

          for SERVICE in nexo-be nexo-fe nexo-auth; do
            VALUES_FILE="local/helm/${SERVICE}/values-prod.yaml"

            if [ -f "$VALUES_FILE" ]; then
              # Atualizar tag da imagem principal
              awk -v new_tag="${VERSION}" '
                BEGIN { found=0 }
                /^image:/ { in_image=1 }
                /^postgresql:/ || /^autoscaling:/ || /^resources:/ { in_image=0 }
                in_image && /tag:/ && !found {
                  sub(/tag: "[^"]*"/, "tag: \"" new_tag "\"")
                  found=1
                }
                { print }
              ' "$VALUES_FILE" > "$VALUES_FILE.tmp" && mv "$VALUES_FILE.tmp" "$VALUES_FILE"

              # Atualizar annotation de commit
              sed -i "s/app.kubernetes.io\/commit: \"[^\"]*\"/app.kubernetes.io\/commit: \"$SHORT_SHA\"/" "$VALUES_FILE"

              # Garantir registry correto
              sed -i "s|repository: .*/${SERVICE}|repository: ${REGISTRY}/${IMAGE_OWNER}/${SERVICE}|" "$VALUES_FILE"

              git add "$VALUES_FILE"
              echo "‚úÖ Updated $VALUES_FILE ‚Üí $VERSION"
            fi
          done

      - name: Commit and push
        run: |
          VERSION="v${{ needs.validate.outputs.version }}"

          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è No changes to commit"
            exit 0
          fi

          git commit -m "release: ${VERSION} - update production helm values [skip ci]"
          git push origin main

          echo "‚úÖ Production values updated to $VERSION"

  # ==========================================================================
  # STAGE 4: Create GitHub Release
  # ==========================================================================
  github-release:
    name: üè∑Ô∏è GitHub Release
    runs-on: ubuntu-latest
    needs:
      - validate
      - build-backend
      - build-frontend
      - build-auth
      - update-helm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog
        id: changelog
        run: |
          VERSION="v${{ needs.validate.outputs.version }}"

          # Pegar a tag anterior
          PREV_TAG=$(git tag --sort=-v:refname | grep -E "^v[0-9]" | head -2 | tail -1)

          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" == "$VERSION" ]; then
            # Primeira release ou tag √∫nica
            CHANGELOG="Initial release"
            COMMITS=$(git log --oneline -20)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" "$PREV_TAG"..HEAD --no-merges | head -50)
            COMMITS=$(git log --oneline "$PREV_TAG"..HEAD --no-merges | head -50)
          fi

          # Categorizar commits
          FEATURES=$(echo "$COMMITS" | grep -iE "^[a-f0-9]+ (feat|feature)" | sed 's/^[a-f0-9]* /- /' || true)
          FIXES=$(echo "$COMMITS" | grep -iE "^[a-f0-9]+ (fix|bugfix|hotfix)" | sed 's/^[a-f0-9]* /- /' || true)
          CHORES=$(echo "$COMMITS" | grep -iE "^[a-f0-9]+ (chore|refactor|ci|docs|style|test)" | sed 's/^[a-f0-9]* /- /' || true)
          OTHER=$(echo "$COMMITS" | grep -viE "^[a-f0-9]+ (feat|feature|fix|bugfix|hotfix|chore|refactor|ci|docs|style|test)" | sed 's/^[a-f0-9]* /- /' || true)

          # Construir body
          BODY="## Nexo Platform ${VERSION}\n\n"
          BODY+="### üì¶ Docker Images\n\n"
          BODY+="| Service | Image |\n"
          BODY+="|---------|-------|\n"
          BODY+="| Backend | \`ghcr.io/${{ env.IMAGE_OWNER }}/nexo-be:${VERSION}\` |\n"
          BODY+="| Frontend | \`ghcr.io/${{ env.IMAGE_OWNER }}/nexo-fe:${VERSION}\` |\n"
          BODY+="| Auth | \`ghcr.io/${{ env.IMAGE_OWNER }}/nexo-auth:${VERSION}\` |\n\n"

          if [ -n "$FEATURES" ]; then
            BODY+="### ‚ú® Features\n\n${FEATURES}\n\n"
          fi
          if [ -n "$FIXES" ]; then
            BODY+="### üêõ Bug Fixes\n\n${FIXES}\n\n"
          fi
          if [ -n "$CHORES" ]; then
            BODY+="### üîß Maintenance\n\n${CHORES}\n\n"
          fi
          if [ -n "$OTHER" ]; then
            BODY+="### üìù Other Changes\n\n${OTHER}\n\n"
          fi

          BODY+="### üöÄ Deployment\n\n"
          BODY+="This release has been automatically deployed to production via ArgoCD.\n"
          BODY+="Helm values updated in \`local/helm/*/values-prod.yaml\`.\n"

          # Salvar em arquivo para evitar problemas com multiline
          echo -e "$BODY" > /tmp/release-body.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: "Nexo Platform v${{ needs.validate.outputs.version }}"
          body_path: /tmp/release-body.md
          draft: false
          prerelease: ${{ needs.validate.outputs.prerelease == 'true' }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # STAGE 5: Discord Notification
  # ==========================================================================
  notify-discord:
    name: üì¢ Discord Release Notify
    runs-on: ubuntu-latest
    needs:
      - validate
      - build-backend
      - build-frontend
      - build-auth
      - update-helm
      - github-release
    if: always() && needs.validate.result == 'success'
    steps:
      - name: Send Discord Release Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          VERSION="v${{ needs.validate.outputs.version }}"
          PRERELEASE="${{ needs.validate.outputs.prerelease }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          REPO="${{ github.repository }}"
          RELEASE_URL="https://github.com/${REPO}/releases/tag/${VERSION}"
          ACTOR="${{ github.actor }}"

          # Determinar status
          BUILD_BE="${{ needs.build-backend.result }}"
          BUILD_FE="${{ needs.build-frontend.result }}"
          BUILD_AUTH="${{ needs.build-auth.result }}"
          HELM_RESULT="${{ needs.update-helm.result }}"
          RELEASE_RESULT="${{ needs.github-release.result }}"

          if [[ "$BUILD_BE" == "success" && "$BUILD_FE" == "success" && "$BUILD_AUTH" == "success" ]]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="sucesso"
            COLOR=3066993  # Verde
          else
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="falhou"
            COLOR=15158332  # Vermelho
          fi

          if [ "$PRERELEASE" == "true" ]; then
            TITLE="üîñ Pre-Release ${VERSION} ${STATUS_EMOJI}"
          else
            TITLE="üöÄ Release ${VERSION} ${STATUS_EMOJI}"
          fi

          # Verificar webhook
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ö†Ô∏è DISCORD_WEBHOOK n√£o configurado - pulando"
            exit 0
          fi

          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg description "Release ${STATUS_TEXT} para produ√ß√£o" \
            --argjson color "$COLOR" \
            --arg version "$VERSION" \
            --arg commit "[\`$SHORT_SHA\`](https://github.com/${REPO}/commit/${{ github.sha }})" \
            --arg be_status "$([ '$BUILD_BE' = 'success' ] && echo '‚úÖ' || echo '‚ùå') nexo-be" \
            --arg fe_status "$([ '$BUILD_FE' = 'success' ] && echo '‚úÖ' || echo '‚ùå') nexo-fe" \
            --arg auth_status "$([ '$BUILD_AUTH' = 'success' ] && echo '‚úÖ' || echo '‚ùå') nexo-auth" \
            --arg helm_status "$([ '$HELM_RESULT' = 'success' ] && echo '‚úÖ Atualizado' || echo '‚ùå Falhou')" \
            --arg release_link "[Ver Release](${RELEASE_URL})" \
            --arg actor "$ACTOR" \
            --arg footer "Nexo Platform ‚Ä¢ Release ${VERSION}" \
            --arg timestamp "$TIMESTAMP" \
            '{
              embeds: [{
                title: $title,
                description: $description,
                color: $color,
                fields: [
                  { name: "üè∑Ô∏è Vers√£o", value: $version, inline: true },
                  { name: "üìù Commit", value: $commit, inline: true },
                  { name: "üë§ Autor", value: $actor, inline: true },
                  { name: "üê≥ Docker Images", value: ($be_status + "\n" + $fe_status + "\n" + $auth_status), inline: false },
                  { name: "üì¶ Helm Prod", value: $helm_status, inline: true },
                  { name: "üîó Release", value: $release_link, inline: true }
                ],
                footer: { text: $footer },
                timestamp: $timestamp
              }]
            }')

          HTTP_RESPONSE=$(curl -s -o /tmp/discord_response.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "${PAYLOAD}" \
            "$DISCORD_WEBHOOK")

          if [ "$HTTP_RESPONSE" -ge 200 ] && [ "$HTTP_RESPONSE" -lt 300 ]; then
            echo "‚úÖ Discord release notification sent! (HTTP $HTTP_RESPONSE)"
          else
            echo "‚ö†Ô∏è Failed to send Discord notification (HTTP $HTTP_RESPONSE)"
            exit 0
          fi
